<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ger√§te-Konfiguration - <%= user.username %>
    </title>
    <link rel="stylesheet" href="/css/global.css">
</head>

<body>
    <div class="container">
        <h1>Ger√§te-Konfiguration</h1>
        <p>Hallo <%= user.username %>! Hier kannst du deinen YourWatcher konfigurieren.</p>

        <% if (flash) { %>
        <div class="flash-message flash-<%= flash.type %>">
            <%= flash.message %>
        </div>
        <% } %>

        <div class="config-form-container">
            <form method="POST" action="/user/setDeviceConfiguration" id="configForm" autocomplete="off">


                <!-- Ger√§te-Auswahl -->
                <div class="form-section">
                    <h3>üì± Ger√§t ausw√§hlen</h3>
                    <div class="form-group">
                        <label for="deviceSelect">Ger√§t:</label>
                        <select name="deviceId" id="deviceSelect" onchange="loadConfig(this.value)">
                            <option value="" selected disabled>Bitte Ger√§t ausw√§hlen</option>
                            <% configurations.forEach(function(item) { %>
                            <option value="<%= item.deviceId %>"><%= item.deviceId %></option>
                            <% }); %>
                        </select>
                    </div>
                </div>

                <!-- Dynamisches Rendering: Basic Felder -->
                <div id="basic-fields"></div>

                <details class="form-section">
                    <summary>
                        <h3>üîß Erweiterte Einstellungen</h3>
                    </summary>
                    <div id="advanced-fields"></div>
                </details>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">üíæ Speichern</button>
                    <a href="/user/profile" class="btn btn-secondary">Zur√ºck</a>
                </div>
            </form>
        </div>

        <div style="margin-top: 1.5rem; text-align: center;">
            <a href="/user/logout" class="btn btn-danger">Abmelden</a>
        </div>
    </div>

    <script>
        // Hilfsfunktion: Wert in verschachteltem Objekt per Key-Path setzen
        function setValueByPath(obj, path, value) {
            const parts = path.replace(/\[(\d+)\]/g, '.$1').split('.');
            let curr = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!curr[parts[i]]) curr[parts[i]] = isNaN(Number(parts[i + 1])) ? {} : [];
                curr = curr[parts[i]];
            }
            curr[parts[parts.length - 1]] = value;
        }

        document.getElementById('configForm').addEventListener('submit', function (e) {
            // Dynamisches Mapping aller Felder
            const formData = new FormData(this);
            const configObj = {};
            deviceConfigSchema.forEach(field => {
                const id = keyToId(field.key);
                let value;
                if (field.type === 'checkbox') {
                    value = formData.get(id) === 'on';
                } else if (field.type === 'tags') {
                    value = formData.get(id)?.split(',').map(s => s.trim()).filter(Boolean) || [];
                } else if (field.type === 'number') {
                    value = formData.get(id);
                    value = value === '' ? null : Number(value);
                } else {
                    value = formData.get(id);
                }

                // Spezialbehandlung f√ºr Intervalle (h/s -> ms)
                if (field.key.startsWith('deviceConfiguration.intervals.')) {
                    if (field.unit === 'h' && value != null) value = TimeUtils.hoursToMs(value);
                    if (field.unit === 's' && value != null) value = TimeUtils.secondsToMs(value);
                }

                setValueByPath(configObj, field.key, value);
            });

            // deviceId extra
            configObj.deviceId = formData.get('deviceId');

            // Sende als JSON (per hidden input)
            let hidden = document.getElementById('configJson');
            if (!hidden) {
                hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'configJson';
                hidden.id = 'configJson';
                this.appendChild(hidden);
            }
            hidden.value = JSON.stringify(configObj);
        });
        const TimeUtils = {
            MS_PER_SECOND: 1000,
            MS_PER_MINUTE: 60 * 1000,
            MS_PER_HOUR: 60 * 60 * 1000,

            msToHours: (ms) => Math.floor(ms / TimeUtils.MS_PER_HOUR),
            msToSeconds: (ms) => Math.floor(ms / TimeUtils.MS_PER_SECOND),
            msToMinutes: (ms) => Math.floor(ms / TimeUtils.MS_PER_MINUTE),

            hoursToMs: (h) => h * TimeUtils.MS_PER_HOUR,
            minutesToMs: (m) => m * TimeUtils.MS_PER_MINUTE,
            secondsToMs: (s) => s * TimeUtils.MS_PER_SECOND,
        };
        // Konfigurationen als JavaScript-Objekt
        // das hier wird falsch formatiert
        const configurations = <%- JSON.stringify(configurations) %> || [];
        const deviceConfigSchema = <%- JSON.stringify(deviceConfigSchema) %>;
        // Hilfsfunktion: Key-Path-zu-Name/ID (z.B. weather.hoursToForecast[0] => weather_hoursToForecast_0)
        function keyToId(key) {
            return key.replace(/\./g, '_').replace(/\[(\d+)\]/g, '_$1');
        }

        // Dynamisches Rendering der Felder
        function renderFields() {
            const basicFields = deviceConfigSchema.filter(f => f.group === 'basic');
            const advancedFields = deviceConfigSchema.filter(f => f.group === 'advanced');
            document.getElementById('basic-fields').innerHTML = basicFields.map(renderField).join('');
            document.getElementById('advanced-fields').innerHTML = advancedFields.map(renderField).join('');
        }

        function renderField(field) {
            const id = keyToId(field.key);
            let html = '';
            if (field.type === 'checkbox') {
                html += `<div class="checkbox-group">
                            <input type="checkbox" name="${id}" id="${id}">
                            <label for="${id}">${field.label}</label>
                        </div>`;
            } else if (field.type === 'tags') {
                html += `<div class="form-group">
                            <label for="${id}">${field.label}</label>
                            <input type="text" name="${id}" id="${id}" placeholder="${field.placeholder || ''}">
                        </div>`;
            } else {
                html += `<div class="form-group">
                            <label for="${id}">${field.label}</label>
                            <input type="${field.type}" name="${id}" id="${id}" 
                                ${field.min !== undefined ? `min=\"${field.min}\"` : ''}
                                ${field.max !== undefined ? `max=\"${field.max}\"` : ''}
                                ${field.step !== undefined ? `step=\"${field.step}\"` : ''}
                                ${field.pattern ? `pattern=\"${field.pattern}\"` : ''}
                                ${field.maxLength ? `maxlength=\"${field.maxLength}\"` : ''}
                                placeholder="${field.placeholder || ''}">
                        </div>`;
            }
            return html;
        }

        // Initiales Rendern
        renderFields();
        console.log("config ", configurations);
        // Hilfsfunktion: Wert aus verschachteltem Objekt per Key-Path holen
        function getValueByPath(obj, path) {
            if (!obj) return undefined;
            const parts = path.replace(/\[(\d+)\]/g, '.$1').split('.');
            return parts.reduce((acc, part) => (acc && acc[part] !== undefined ? acc[part] : undefined), obj);
        }

        function loadConfig(deviceId) {
            const config = configurations.find(c => c.deviceId === deviceId);
            if (!config || !config.config) return;
            const cfg = config.config;

            deviceConfigSchema.forEach(field => {
                const id = keyToId(field.key);
                const el = document.getElementById(id);
                if (!el) return;
                let value = getValueByPath(cfg, field.key);

                // Spezialbehandlung f√ºr Intervalle (ms <-> h/s)
                if (field.key.startsWith('deviceConfiguration.intervals.')) {
                    if (value !== undefined && value !== null) {
                        if (field.unit === 'h') value = TimeUtils.msToHours(value);
                        if (field.unit === 's') value = TimeUtils.msToSeconds(value);
                    } else {
                        value = '';
                    }
                }

                // Checkboxen
                if (field.type === 'checkbox') {
                    el.checked = !!value;
                } else if (field.type === 'tags') {
                    // Arrays als Komma-getrennte Strings
                    el.value = Array.isArray(value) ? value.join(', ') : (value || '');
                } else {
                    el.value = value ?? '';
                }
            });
        }

        // PLZ-Lookup f√ºr automatische Koordinaten
        async function lookupZipCode(zipCode) {
            const statusEl = document.getElementById('zipCodeStatus');
            const latEl = document.getElementById('latitude');
            const lngEl = document.getElementById('longitude');

            if (!zipCode || zipCode.length !== 5) {
                statusEl.textContent = '';
                statusEl.className = 'field-status';
                return;
            }

            try {
                statusEl.textContent = 'Suche...';
                statusEl.className = 'field-status';

                const response = await fetch(`/utils/zipCode/${zipCode}`);

                if (response.ok) {
                    const data = await response.json();
                    latEl.value = data.latitude;
                    lngEl.value = data.longitude;
                    statusEl.textContent = '‚úì Koordinaten gefunden';
                    statusEl.className = 'field-status field-status-success';
                } else {
                    latEl.value = '';
                    lngEl.value = '';
                    statusEl.textContent = '‚úó PLZ nicht gefunden';
                    statusEl.className = 'field-status field-status-error';
                }
            } catch (error) {
                console.error('PLZ-Lookup Fehler:', error);
                statusEl.textContent = '‚úó Fehler bei der Abfrage';
                statusEl.className = 'field-status field-status-error';
            }
        }

        // Event Listener f√ºr PLZ-Eingabe
        document.getElementById('zipCode').addEventListener('input', function (e) {
            const zipCode = e.target.value.replace(/\D/g, ''); // Nur Zahlen
            e.target.value = zipCode;

            if (zipCode.length === 5) {
                lookupZipCode(zipCode);
            }
        });

        // Beim Laden die erste Konfiguration anzeigen
        document.addEventListener('DOMContentLoaded', function () {
            if (configurations.length > 0) {
                loadConfig(configurations[0].deviceId);
            }

            // Flash-Message nach 4 Sekunden ausblenden
            const flashMessage = document.querySelector('.flash-message');
            if (flashMessage) {
                setTimeout(() => {
                    flashMessage.classList.add('fade-out');
                    setTimeout(() => flashMessage.remove(), 500);
                }, 4000);
            }
        });
    </script>
</body>

</html>