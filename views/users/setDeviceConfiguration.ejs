<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ger√§te-Konfiguration - <%= user.username %>
    </title>
    <link rel="stylesheet" href="/css/global.css">
</head>

<body>
    <div class="container">
        <h1>Ger√§te-Konfiguration</h1>
        <p>Hallo <%= user.username %>! Hier kannst du deinen YourWatcher konfigurieren.</p>

        <% if (flash) { %>
        <div class="flash-message flash-<%= flash.type %>">
            <%= flash.message %>
        </div>
        <% } %>

        <div class="config-form-container">
            <form method="POST" action="/user/setDeviceConfiguration" id="configForm" autocomplete="off">


                <!-- Ger√§te-Auswahl -->
                <div class="form-section">
                    <h3 id="device-selection">üì± Ger√§t ausw√§hlen</h3>
                    <div class="form-group">
                        <label for="deviceSelect">Ger√§t:</label>
                        <select name="deviceId" id="deviceSelect" onchange="loadConfig(this.value)">
                            <option value="" selected disabled>Bitte Ger√§t ausw√§hlen</option>
                            <% configurations.forEach(function(item) { %>
                            <option value="<%= item.deviceId %>"><%= item.deviceId %></option>
                            <% }); %>
                        </select>
                    </div>
                </div>

                <!-- Dynamisches Rendering: Basic Felder -->
                <div id="categories-container">
                    <div id="basic-fields"></div>
                </div>
                <details class="form-section">
                    <summary>
                        <h3>üîß Erweiterte Einstellungen</h3>
                    </summary>
                    <div id="advanced-fields"></div>
                </details>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">üíæ Speichern</button>
                    <a href="/user/profile" class="btn btn-secondary">Zur√ºck</a>
                </div>
            </form>
        </div>

        <div style="margin-top: 1.5rem; text-align: center;">
            <a href="/user/logout" class="btn btn-danger">Abmelden</a>
        </div>
    </div>

    <script>
        // ==== Konstanten & Hilfsfunktionen ====
        const TimeUtils = {
            MS_PER_SECOND: 1000,
            MS_PER_MINUTE: 60 * 1000,
            MS_PER_HOUR: 60 * 60 * 1000,
            msToHours: ms => Math.floor(ms / TimeUtils.MS_PER_HOUR),
            msToSeconds: ms => Math.floor(ms / TimeUtils.MS_PER_SECOND),
            msToMinutes: ms => Math.floor(ms / TimeUtils.MS_PER_MINUTE),
            hoursToMs: h => h * TimeUtils.MS_PER_HOUR,
            minutesToMs: m => m * TimeUtils.MS_PER_MINUTE,
            secondsToMs: s => s * TimeUtils.MS_PER_SECOND,
        };

        function setValueByPath(obj, path, value) {
            const parts = path.replace(/\[(\d+)\]/g, '.$1').split('.');
            let curr = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!curr[parts[i]]) curr[parts[i]] = isNaN(Number(parts[i + 1])) ? {} : [];
                curr = curr[parts[i]];
            }
            curr[parts[parts.length - 1]] = value;
        }

        function getValueByPath(obj, path) {
            if (!obj) return undefined;
            const parts = path.replace(/\[(\d+)\]/g, '.$1').split('.');
            return parts.reduce((acc, part) => (acc && acc[part] !== undefined ? acc[part] : undefined), obj);
        }

        function keyToId(key) {
            return key.replace(/\./g, '_').replace(/\[(\d+)\]/g, '_$1');
        }

        // ==== Globale Variablen ====
        let stopIds = [];
        const configurations = <%- JSON.stringify(configurations) %> || [];
        const deviceConfigSchema = <%- JSON.stringify(deviceConfigSchema) %>;

        // ==== Rendering ====
        function renderFields() {
            const basicFields = deviceConfigSchema.filter(f => f.group === 'basic');
            const advancedFields = deviceConfigSchema.filter(f => f.group === 'advanced');
            const categoryMap = {};

            basicFields.forEach(field => {
                if (field.category) {
                    if (!categoryMap[field.category]) categoryMap[field.category] = [];
                    categoryMap[field.category].push(field);
                }
            });

            const basicFieldsHtml = Object.entries(categoryMap).map(([category, fields]) =>
                `<fieldset class="form-category">
                <legend>${category}</legend>
                ${fields.map(renderField).join('')}
            </fieldset>`
            ).join('');

            document.getElementById('basic-fields').innerHTML = basicFieldsHtml;
            document.getElementById('advanced-fields').innerHTML = advancedFields.map(renderField).join('');
        }

        function renderField(field) {
            const id = keyToId(field.key);
            if (field.type === 'checkbox') {
                return `<div class="checkbox-group">
                        <input type="checkbox" name="${id}" id="${id}">
                        <label for="${id}">${field.label}</label>
                    </div>`;
            }
            if (field.type === 'tags') {
                return `<div class="form-group">
                        <label for="${id}">${field.label}</label>
                        <input type="text" name="${id}" id="${id}" placeholder="${field.placeholder || ''}">
                    </div>`;
            }
            if (field.type === "search") {
                return `
                <div class="form-group">
                <label for="stopIdsSearchInput">${field.label}</label>
                    <input type="text" id="stopIdsSearchInput" placeholder="Haltestelle suchen...">
                    <div id="stopIdsSearchSuggestions"></div>
                    <div class="stopTags" id="stopIdsSearchTags"></div>
                    </div>`;
            }
            return `<div class="form-group">
                    <label for="${id}">${field.label}</label>
                    <input type="${field.type}" name="${id}" id="${id}" 
                        ${field.min !== undefined ? `min="${field.min}"` : ''}
                        ${field.max !== undefined ? `max="${field.max}"` : ''}
                        ${field.step !== undefined ? `step="${field.step}"` : ''}
                        ${field.pattern ? `pattern="${field.pattern}"` : ''}
                        ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}
                        placeholder="${field.placeholder || ''}">
                </div>`;
        }

        // ==== StopId-Suche & Tags ====
        async function handleStopIdSearchInput(e) {
            const query = e.target.value;
            if (query.length < 3) return;
            const res = await fetch(`/utils/stopIdSearch/${encodeURIComponent(query)}`);
            const stops = await res.json();
            const suggestions = stops.map(stop =>
                `<div class="suggestionItem" data-id="${stop.id}" data-name="${stop.name}">${stop.name} (${stop.id})</div>`
            ).join('');
            document.getElementById("stopIdsSearchSuggestions").innerHTML = suggestions;
        }

        function handleStopIdSuggestionClick(e) {
            if (e.target.classList.contains('suggestionItem')) {
                const id = e.target.dataset.id;
                const name = e.target.dataset.name;
                if (!stopIds.some(s => s.id === id)) {
                    stopIds.push({ id, name });
                    renderStopIdsTags();
                }
                document.getElementById('stopIdsSearchInput').value = '';
                document.getElementById('stopIdsSearchSuggestions').innerHTML = '';
            }
        }

        function renderStopIdsTags() {
            document.getElementById('stopIdsSearchTags').innerHTML = stopIds.map(s =>
                `<span class="suggestionItem">${s.name} (${s.id}) <button class="closeBtn" type="button" onclick="removeStopId('${s.id}')">x</button></span>`
            ).join('');
        }

        window.removeStopId = function (id) {
            stopIds = stopIds.filter(s => s.id !== id);
            renderStopIdsTags();
        };

        function addEventListeners() {
            document.getElementById("stopIdsSearchInput")?.addEventListener("input", handleStopIdSearchInput);
            document.getElementById('stopIdsSearchSuggestions')?.addEventListener('click', handleStopIdSuggestionClick);
        }

        // ==== Formular-Handling ====
        function handleFormSubmit(e) {
            const formData = new FormData(this);
            const configObj = {};

            deviceConfigSchema.forEach(field => {
                const id = keyToId(field.key);
                let value;
                if (field.type === 'checkbox') {
                    value = formData.get(id) === 'on';
                } else if (field.type === 'tags') {
                    value = formData.get(id)?.split(',').map(s => s.trim()).filter(Boolean) || [];
                } else if (field.type === 'search') {
                    // value = stopIds.map(s => s.id);
                    value = stopIds;
                } else if (field.type === 'number') {
                    value = formData.get(id);
                    value = value === '' ? null : Number(value);
                } else {
                    value = formData.get(id);
                }

                // Spezialbehandlung f√ºr Intervalle (h/s -> ms)
                if (field.key.startsWith('deviceConfiguration.intervals.')) {
                    if (field.unit === 'h' && value != null) value = TimeUtils.hoursToMs(value);
                    if (field.unit === 's' && value != null) value = TimeUtils.secondsToMs(value);
                }
                setValueByPath(configObj, field.key, value);
            });

            configObj.deviceId = formData.get('deviceId');

            let hidden = document.getElementById('configJson');
            if (!hidden) {
                hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'configJson';
                hidden.id = 'configJson';
                this.appendChild(hidden);
            }
            hidden.value = JSON.stringify(configObj);
        }

        // ==== Konfiguration laden ====
        function loadConfig(deviceId) {
            const config = configurations.find(c => c.deviceId === deviceId);
            if (!config || !config.config) return;
            const cfg = config.config;
            deviceConfigSchema.forEach(field => {
                let id;
                if (field.key.includes("stopIds")) {
                    id = "stopIdsSearchTags";
                } else {
                    id = keyToId(field.key);
                }
                const el = document.getElementById(id);
                if (!el) return;
                let value = getValueByPath(cfg, field.key);
                if (field.key.startsWith('deviceConfiguration.intervals.')) {
                    if (value !== undefined && value !== null) {
                        if (field.unit === 'h') value = TimeUtils.msToHours(value);
                        if (field.unit === 's') value = TimeUtils.msToSeconds(value);
                    } else {
                        value = '';
                    }
                }
                console.log(`Setting field ${field.key} (id: ${id}) to value:`, value);
                if (field.type === 'checkbox') {
                    el.checked = !!value;
                } else if (field.type === 'tags') {
                    el.value = Array.isArray(value) ? value.join(', ') : (value || '');
                } else if (field.type === 'search') {
                    stopIds = Array.isArray(value) ? value : [];
                    renderStopIdsTags();
                    el.value = '';
                } else {
                    el.value = value ?? '';
                }
            });
            document.getElementById('device-selection').innerHTML = deviceId ? `üì± Ger√§t: ${deviceId}` : 'üì± Ger√§t ausw√§hlen';
        }

        // ==== Initialisierung ====
        function init() {
            renderFields();
            addEventListeners();
            document.getElementById('configForm').addEventListener('submit', handleFormSubmit);

            // Flash-Message nach 4 Sekunden ausblenden
            const flashMessage = document.querySelector('.flash-message');
            if (flashMessage) {
                setTimeout(() => {
                    flashMessage.classList.add('fade-out');
                    setTimeout(() => flashMessage.remove(), 500);
                }, 4000);
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>